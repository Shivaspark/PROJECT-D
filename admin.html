<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Projects • Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Lato','sans-serif'], heading: ['Cinzel','serif'] },
          colors: { 'primary-blue':'#005daa','accent-blue':'#00a9e0','dark-bg':'#111827','dark-secondary':'#1f2937','light-text':'#f9fafb' }
        }
      }
    }
  </script>
</head>
<body class="bg-dark-bg text-light-text min-h-screen">
  <header class="bg-dark-secondary border-b border-gray-800">
    <div class="container mx-auto px-6 py-4 flex items-center justify-between">
      <h1 class="text-xl font-heading font-black">Admin • Manage Projects</h1>
      <a href="/" class="text-accent-blue hover:text-white">← Back to site</a>
    </div>
  </header>

  <main class="container mx-auto px-6 py-8">
    <div class="grid grid-cols-1 gap-6">
      <form id="project-form" class="bg-dark-secondary p-6 rounded-lg border border-gray-700">
        <h2 class="text-xl font-bold text-accent-blue mb-4">Add / Edit Project</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-300 text-sm mb-1">Title</label>
            <input id="pf-title" class="w-full bg-dark-bg border border-gray-600 rounded px-3 py-2 text-gray-200" placeholder="Project title" />
          </div>
          <div>
            <label class="block text-gray-300 text-sm mb-1">Type</label>
            <select id="pf-type" class="w-full bg-dark-bg border border-gray-600 rounded px-3 py-2 text-gray-200">
              <option value="flagship">Flagship</option>
              <option value="upcoming">Upcoming</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-gray-300 text-sm mb-1">Image</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="pf-image" class="w-full bg-dark-bg border border-gray-600 rounded px-3 py-2 text-gray-200" placeholder="https://... or assets/images/projects/p-2.jpg" />
              <input id="pf-file" type="file" accept="image/*" class="w-full bg-dark-bg border border-gray-600 rounded px-3 py-2 text-gray-200" />
            </div>
            <p class="text-xs text-gray-500 mt-1">Provide a URL or upload a file. Upload will auto-fill the URL.</p>
            <img id="pf-preview" src="" alt="Preview" class="mt-2 h-24 w-40 object-cover rounded border border-gray-700 hidden" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-gray-300 text-sm mb-1">Description</label>
            <textarea id="pf-desc" rows="4" class="w-full bg-dark-bg border border-gray-600 rounded px-3 py-2 text-gray-200" placeholder="Project description..."></textarea>
          </div>
        </div>
        <div class="mt-4 flex gap-3">
          <button id="pf-submit" type="submit" class="bg-primary-blue text-white px-5 py-2 rounded-full hover:bg-accent-blue transition">Add Project</button>
          <button id="pf-reset" type="button" class="bg-gray-700 text-white px-4 py-2 rounded-full hover:bg-gray-600 transition">Reset</button>
        </div>
      </form>
      <div class="bg-dark-secondary p-6 rounded-lg border border-gray-700">
        <h2 class="text-xl font-bold text-accent-blue mb-4">Existing Projects</h2>
        <div id="projects-list" class="space-y-3"></div>
      </div>
    </div>
  </main>

  <script>
    function projectRowHTML(p) {
      return `
        <div class="project-row border border-gray-700 rounded p-3 flex flex-col md:flex-row md:items-start gap-3 cursor-pointer hover:bg-dark-bg/40" data-id="${p.id}">
          <img src="${p.image}" alt="${p.title}" class="w-24 h-16 object-cover rounded border border-gray-600"/>
          <div class="flex-1 min-w-0">
            <div class="text-accent-blue font-semibold">${p.title}</div>
            <div class="text-gray-400 text-sm break-words whitespace-normal overflow-hidden">${p.description}</div>
            <div class="text-gray-500 text-xs mt-1">Type: ${p.type} • ID: ${p.id}</div>
          </div>
          <div class="flex gap-2">
            <button data-id="${p.id}" class="btn-edit bg-primary-blue text-white px-3 py-1 rounded-full">Edit</button>
            <button data-id="${p.id}" class="btn-delete bg-gray-700 text-white px-3 py-1 rounded-full">Delete</button>
          </div>
        </div>`
    }

    function setPreview(url){
      const preview = document.getElementById('pf-preview');
      if (!preview) return;
      if (url) { preview.src = url; preview.classList.remove('hidden'); }
      else { preview.src=''; preview.classList.add('hidden'); }
    }
    function prefillForm(item) {
      document.getElementById('pf-title').value = item.title;
      document.getElementById('pf-type').value = item.type;
      document.getElementById('pf-image').value = item.image;
      setPreview(item.image);
      document.getElementById('pf-desc').value = item.description;
      document.getElementById('pf-submit').textContent = 'Update Project';
      document.getElementById('project-form').setAttribute('data-edit-id', item.id);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function refreshAdminList() {
      const list = document.getElementById('projects-list');
      const res = await fetch('/api/projects');
      const { projects } = await res.json();
      list.innerHTML = projects.map(projectRowHTML).join('');

      // Delete
      list.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = e.currentTarget.getAttribute('data-id');
        if (!confirm('Delete this project?')) return;
        await fetch(`/api/projects/${id}`, { method: 'DELETE' });
        await refreshAdminList();
      }));

      // Edit button
      list.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = e.currentTarget.getAttribute('data-id');
        const res = await fetch('/api/projects');
        const { projects } = await res.json();
        const item = projects.find(p => p.id === id);
        if (!item) return;
        prefillForm(item);
        highlightRow(id);
      }));

      // Row click selection
      list.querySelectorAll('.project-row').forEach(row => row.addEventListener('click', async (e) => {
        const id = row.getAttribute('data-id');
        const res = await fetch('/api/projects');
        const { projects } = await res.json();
        const item = projects.find(p => p.id === id);
        if (!item) return;
        prefillForm(item);
        highlightRow(id);
      }));

      function highlightRow(id) {
        list.querySelectorAll('.project-row').forEach(el => el.classList.remove('ring-2','ring-accent-blue'));
        const active = list.querySelector(`.project-row[data-id="${id}"]`);
        if (active) active.classList.add('ring-2','ring-accent-blue');
      }
    }

    function attachAdminHandlers() {
      const form = document.getElementById('project-form');
      const resetBtn = document.getElementById('pf-reset');
      const fileInput = document.getElementById('pf-file');
      const imageInput = document.getElementById('pf-image');

      imageInput.addEventListener('input', () => setPreview(imageInput.value.trim()));

      fileInput.addEventListener('change', async () => {
        const f = fileInput.files && fileInput.files[0];
        if (!f) return;
        const fd = new FormData();
        fd.append('file', f);
        const resp = await fetch('/api/upload', { method: 'POST', body: fd });
        const data = await resp.json();
        if (resp.ok && data.url) {
          imageInput.value = data.url;
          setPreview(data.url);
        } else {
          alert(data.error || 'Upload failed');
        }
        fileInput.value = '';
      });

      resetBtn.addEventListener('click', () => {
        form.reset();
        setPreview('');
        form.removeAttribute('data-edit-id');
        document.getElementById('pf-submit').textContent = 'Add Project';
      });
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          title: document.getElementById('pf-title').value.trim(),
          type: document.getElementById('pf-type').value,
          image: document.getElementById('pf-image').value.trim(),
          description: document.getElementById('pf-desc').value.trim()
        };
        const editId = form.getAttribute('data-edit-id');
        if (editId) {
          await fetch(`/api/projects/${editId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        } else {
          await fetch('/api/projects', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }
        form.reset();
        form.removeAttribute('data-edit-id');
        document.getElementById('pf-submit').textContent = 'Add Project';
        await refreshAdminList();
      });
      refreshAdminList();
    }

    document.addEventListener('DOMContentLoaded', attachAdminHandlers);
  </script>
</body>
</html>
